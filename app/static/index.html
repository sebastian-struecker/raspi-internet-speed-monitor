<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Internet Speed Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      padding: 1.5rem;
    }

    h1 { font-size: 1.5rem; margin-bottom: 1.5rem; color: #f8fafc; }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 1.2rem 1.5rem;
      text-align: center;
    }

    .card .label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: .05em; }
    .card .value { font-size: 2rem; font-weight: 700; margin: .3rem 0; }
    .card .unit  { font-size: 0.8rem; color: #94a3b8; }

    .download { color: #34d399; }
    .upload   { color: #60a5fa; }
    .ping     { color: #f472b6; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    input[type="datetime-local"] {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      padding: .45rem .75rem;
      font-size: .875rem;
    }

    button {
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      font-size: .875rem;
      padding: .5rem 1.25rem;
    }
    button:hover { background: #2563eb; }

    .chart-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 1.5rem;
    }

    #refreshInfo { font-size: .75rem; color: #64748b; margin-top: .5rem; }
  </style>
</head>
<body>
  <h1>Internet Speed Monitor</h1>

  <div class="controls">
    <label>Timeframe
      <select id="timeframeSelect" onchange="applyTimeframe()">
        <option value="1">1 day</option>
        <option value="3" selected>3 days</option>
        <option value="7">7 days</option>
        <option value="30">30 days</option>
        <option value="custom">Custom</option>
      </select>
    </label>
    <label>From <input type="datetime-local" id="startDt" step="3600" onchange="markCustom()" /></label>
    <label>To   <input type="datetime-local" id="endDt" step="3600" onchange="markCustom()" /></label>
    <button onclick="loadData()">Refresh</button>
  </div>

  <div class="metrics">
    <div class="card">
      <div class="label">Avg Download</div>
      <div class="value download" id="avgDl">—</div>
      <div class="unit">Mbps</div>
    </div>
    <div class="card">
      <div class="label">Avg Upload</div>
      <div class="value upload" id="avgUl">—</div>
      <div class="unit">Mbps</div>
    </div>
    <div class="card">
      <div class="label">Avg Ping</div>
      <div class="value ping" id="avgPing">—</div>
      <div class="unit">ms</div>
    </div>
    <div class="card">
      <div class="label">Tests</div>
      <div class="value" style="font-size:1.5rem;padding-top:.6rem" id="testsCount">—</div>
      <div class="unit">&nbsp;</div>
    </div>
  </div>

  <div class="chart-card">
    <canvas id="chart" height="120"></canvas>
  </div>
  <div id="refreshInfo"></div>

  <script>
    const AUTO_REFRESH_MS = 60_000;

    // --- Chart setup ---
    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Download (Mbps)', data: [], borderColor: '#34d399', tension: 0.3, fill: false },
          { label: 'Upload (Mbps)',   data: [], borderColor: '#60a5fa', tension: 0.3, fill: false },
          { label: 'Ping (ms)',       data: [], borderColor: '#f472b6', tension: 0.3, fill: false }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { ticks: { color: '#94a3b8' }, grid: { color: '#1e293b' } },
          y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
        },
        plugins: { legend: { labels: { color: '#e2e8f0' } } }
      }
    });

    // --- Stats for selected period ---
    async function loadStats(start, end) {
      const res = await fetch(`api/stats?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
      const data = await res.json();

      if (!data) {
        document.getElementById('avgDl').textContent = '—';
        document.getElementById('avgUl').textContent = '—';
        document.getElementById('avgPing').textContent = '—';
        document.getElementById('testsCount').textContent = '0';
        return;
      }

      document.getElementById('avgDl').textContent = data.averages.download_mbps.toFixed(1);
      document.getElementById('avgUl').textContent = data.averages.upload_mbps.toFixed(1);
      document.getElementById('avgPing').textContent = data.averages.ping_ms.toFixed(0);
      document.getElementById('testsCount').textContent = data.tests.total - data.tests.failed;
    }

    // --- History chart ---
    async function loadHistory(start, end) {
      const res  = await fetch(`api/history?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
      const data = await res.json();

      // Exclude failed tests so their 0-values don't distort the chart
      const ok = data.filter(r => r.success);
      chart.data.labels             = ok.map(r => new Date(r.timestamp).toLocaleString());
      chart.data.datasets[0].data  = ok.map(r => r.download_mbps);
      chart.data.datasets[1].data  = ok.map(r => r.upload_mbps);
      chart.data.datasets[2].data  = ok.map(r => r.ping_ms);
      chart.update();
    }

    // --- Load both stats and history ---
    async function loadData() {
      const start = document.getElementById('startDt').value;
      const end   = document.getElementById('endDt').value;
      if (!start || !end) return;

      await loadStats(start, end);
      await loadHistory(start, end);
    }

    // --- Timeframe helpers ---
    function formatDateTime(date) {
      // Format to YYYY-MM-DDTHH:00 (hour precision)
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hour = String(date.getHours()).padStart(2, '0');
      return `${year}-${month}-${day}T${hour}:00`;
    }

    function setDateRange(days) {
      const now = new Date();
      const since = new Date(now - days * 24 * 60 * 60 * 1000);
      document.getElementById('startDt').value = formatDateTime(since);
      document.getElementById('endDt').value = formatDateTime(now);
    }

    function applyTimeframe() {
      const select = document.getElementById('timeframeSelect');
      const value = select.value;
      if (value !== 'custom') {
        setDateRange(parseInt(value));
        loadData();
      }
    }

    function markCustom() {
      document.getElementById('timeframeSelect').value = 'custom';
    }

    function setDefaultRange() {
      setDateRange(3); // Default: 3 days
    }

    // --- Auto-refresh ---
    function scheduleRefresh() {
      const next = new Date(Date.now() + AUTO_REFRESH_MS);
      document.getElementById('refreshInfo').textContent =
        `Auto-refresh at ${next.toLocaleTimeString()}`;
    }

    async function refresh() {
      await loadData();
      scheduleRefresh();
    }

    // --- Init ---
    setDefaultRange();
    refresh();
    setInterval(refresh, AUTO_REFRESH_MS);
  </script>
</body>
</html>
